<!-- 중고 피규어 거래 플랫폼 Nendoroo!-->
<!DOCTYPE html>
<html lang="ko">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />

    <!-- 폰트어썸 -->
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
      integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm"
      crossorigin="anonymous"
    />

    <style>
      * {
        box-sizing: border-box;
      }

      #uploadbtn:hover {
        background-color: bisque;
      }

      #mypagebtn:hover {
        background-color: bisque;
      }

      #logoutbtn:hover {
        background-color: bisque;
      }

      .loginbtn:hover {
        background-color: bisque;
      }
    </style>

    <title>넨도루 | 중고 피규어 거래소</title>
  </head>

  <body class="mx-auto">
    <!-- 모달 -->
    <button
      id="modalpopbtn"
      style="display: none"
      type="button"
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#staticBackdrop"
    >
      모달버튼
    </button>
    <div
      class="modal fade"
      id="staticBackdrop"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header d-flex flex-column">
            <h5 class="modal-title" id="staticBackdropLabel">
              신규가입을 환영합니다!
            </h5>
            <h4>사용하실 닉네임을 입력해주세요.</h4>
            <p style="color: red">
              한번 설정하시면 변경하실 수 없습니다.<br />변경하시려면, 탈퇴 후
              재가입 하셔야 합니다.
            </p>

            <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
          </div>
          <div class="modal-body">
            <input
              id="nameinput"
              type="text"
              class="form-control"
              placeholder="닉네임 입력"
              aria-label="Username"
            />
          </div>
          <div class="modal-footer">
            <button
              id="closebtn"
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              닫기
            </button>
            <button id="okbtn" type="button" class="btn btn-primary">
              완료
            </button>
          </div>
        </div>
      </div>
    </div>
    <!--  -->
    <nav class="mx-auto w-75 navbar navbar-expand-xxl navbar-light light mb-2">
      <div class="container-fluid">
        <a class="navbar-brand" href="/index.html"
          ><img src="img/Nendoroo (250 × 100px).svg" alt="" srcset=""
        /></a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse my-4" id="navbarSupportedContent">
          <form class="d-flex mx-auto" style="height: 3rem">
            <input
              class="form-control me-2"
              type="search"
              placeholder="검색"
              aria-label="Search"
            />
            <button class="btn btn-outline-secondary" type="submit">
              Search
            </button>
          </form>
          <ul class="w-50 justify-content-evenly navbar-nav mb-2 mb-lg-0">
            <li id="uploadbtn" class="nav-item">
              <a
                style="font-size: larger; font-weight: bolder; color: black"
                class="nav-link"
                href="#"
                >판매하기</a
              >
            </li>
            <li id="mypagebtn" class="nav-item">
              <a
                style="font-size: larger; font-weight: bolder; color: black"
                class="nav-link"
                href="#"
                >마이페이지</a
              >
            </li>
            <!-- 평소에는 안보이고 있음 -->
            <li id="logout" style="display: none" class="nav-item">
              <a
                id="logoutbtn"
                style="
                  cursor: pointer;
                  font-size: larger;
                  font-weight: bolder;
                  color: black;
                "
                class="nav-link"
                >로그아웃</a
              >
            </li>

            <ul id="logindrop" class="navbar-nav">
              <li class="nav-item dropdown">
                <a
                  style="font-weight: bolder; color: black; font-size: larger"
                  class="loginbtn nav-link dropdown-toggle"
                  href="#"
                  id="navbarDarkDropdownMenuLink"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  로그인
                </a>
                <ul
                  class="p-3 dropdown-menu dropdown-menu-dark"
                  aria-labelledby="navbarDarkDropdownMenuLink"
                >
                  <div class="d-flex flex-column align-items-center">
                    <li class="m-3">
                      <a
                        id="google"
                        class="rounded-pill border border-2 dropdown-item p-3"
                        href="#"
                        style="display: inline"
                        ><img
                          style="margin-right: 1rem"
                          width="25"
                          height="25"
                          src="img/google.svg"
                          alt=""
                        />구글 로그인</a
                      >
                    </li>

                    <p class="pt-3">
                      현재 브라우저에 로그인 되어있는 구글 계정과 연동하게
                      됩니다.
                    </p>
                  </div>
                </ul>
              </li>
            </ul>
          </ul>
        </div>
      </div>
    </nav>

    <!-- 넷바 끝 -->

    <!-- 상세페이지 시작 -->
    <div style="background-color: #f9f9f9">
      <div id="detailInfo" class="container">
        <!-- 번개장터 상세페이지처럼 똑같이 제작!!!! -->

        <!-- 상단부분  -->
        <div class="row">
          <div class="col-12 col-lg-7 col-xl-6">
            <img
              width="100%"
              style="object-fit: contain"
              src="img/17d88064a952f9d0e.jpg"
              alt=""
              srcset=""
            />
          </div>
          <div
            class="col-12 col-lg-5 col-xl-6 d-flex flex-column justify-content-around p-3"
          >
            <div>
              <span>업로더:</span>
              <span>업로더이름</span>
            </div>

            <p>제목제목제목제목제목제목제목제목</p>
            <p>가격가격가격가격가격가격가격가격가격가격</p>
            <p>
              내용내용내용내용내용내용내용내용내용내용내용내용내용내용내용내용내용내용내용내용
            </p>
            <p>업로드날짜날짜날짜날짜날짜날짜</p>
            <div class="d-grid gap-2 d-md-block">
              <button class="btn btn-outline-secondary me-md-2" type="button">
                <i class="far fa-star"></i> 찜 (찜한사람들 배열길이)
              </button>
              <button class="btn btn-danger me-md-2" type="button">
                안전구매
              </button>
            </div>
          </div>
        </div>

        <!-- 하단 부분 작성해야함 -->
        <!--( 밑에는 판매자가 팔고있는 다른 피규어들 카드로 나열해줌
            ~~님이 업로드한 상품들  이라고 적고 밑에 카드들 나열, 팔렸던 상품들은
            예약완료 혹은 판매완료 처리로 상품사진이 블라인드처리되며 적혀져 있어야한다 -->

        <div style="background-color: #f9f9f9">
          <div class="container p-0">
            <h5>
              (쿼리스트링의 id와 일치하는, product컬렉션의 상품중에서의 uid를
              찾고 그곳의 현재업로더의 닉네임을 가져옴) 님이 업로드한 상품들
            </h5>
            <!-- 카드 큰 틀-->
            <div
              class="card-area row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-2 g-lg-3"
            >
              <div class="col">
                <div
                  data-id="${doc.id}"
                  class="card h-100"
                  id="thisiscard"
                  style="cursor: pointer"
                >
                  <img
                    width="200"
                    height="200"
                    style="object-fit: cover"
                    src="${doc.data().정보.이미지}"
                    class="card-img-top"
                    alt=""
                  />

                  <div class="card-body pb-0">
                    <p
                      class="fw-bolder card-title"
                      style="
                        font-size: 14px;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        word-wrap: break-word;
                        display: -webkit-box;
                        -webkit-line-clamp: 1;
                        -webkit-box-orient: vertical;
                      "
                    >
                      ${doc.data().정보.제목}
                    </p>

                    <p class="fw-bolder">${doc.data().정보.가격} 원</p>

                    <p>${doc.data().정보.날짜}</p>
                  </div>
                </div>
              </div>
            </div>
            <!--  -->
          </div>
          <!-- 큰 틀 -->
        </div>

        <!--  -->
      </div>
    </div>

    <!-- 제이쿼리 -->
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>

    <!-- firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBWX9DpbEhu3ZM9qsFuMwUgPDCODl5j3KI",
        authDomain: "nendoroo.firebaseapp.com",
        projectId: "nendoroo",
        storageBucket: "nendoroo.appspot.com",
        messagingSenderId: "544914137707",
        appId: "1:544914137707:web:32991f1ab2f60c87f6072e",
        measurementId: "G-NL1MPPR95L",
      };
      firebase.initializeApp(firebaseConfig);
    </script>

    <script>
      // 천자리수 콤마 함수
      // function priceToString(price) {
      //   return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      // }

      const db = firebase.firestore();

      //페이지 들어오자마자 검사한다. 로그인되어있다면, 로그아웃버튼 유지하는 로직

      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          // 로그인이 되었으니까,
          // 로그인버튼 안보이게하고
          $("#logindrop").hide();
          // 로그아웃버튼 보여주기
          $("#logout").show();
          // var uid = user.uid;
        } else {
        }
      });
      //

      //쿼리스트링에 써있는 아이디와 일치하는 문서를 db에서 꺼내온다
      let 쿼리스트링 = new URLSearchParams(window.location.search); //-> 오브젝트로 반환
      db.collection("product")
        .doc(쿼리스트링.get("id"))
        .get()
        .then((result) => {
          // console.log(result.data());
          // 동적으로 태그 화면생성하자
          // $("#detailInfo").append(``);
        });

      // 판매하기 , 마이페이지 버튼  클릭시, 로그인했는지 검사
      $("#uploadbtn").on("click", () => {
        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            //로그인되어있으면 업로드페이지로 이동
            window.location.href = "/upload.html";
          } else {
            alert("로그인이 필요합니다");
            window.location.href = "/index.html";
          }
        });
      });
      //
      $("#mypagebtn").on("click", () => {
        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            //로그인되어있으면 업로드페이지로 이동
            window.location.href = "/mypage.html";
          } else {
            alert("로그인이 필요합니다");
            window.location.href = "/index.html";
          }
        });
      });

      let provider = new firebase.auth.GoogleAuthProvider();

      // 구글로그인 클릭시
      $("#google").on("click", () => {
        firebase
          .auth()
          .signInWithPopup(provider)
          .then(async (result) => {
            // console.log(result.user);

            // console.log(result);

            // result.additionalUserInfo.isNewUser == true 이면, 신규가입자
            // result.additionalUserInfo.isNewUser == false 이면, 기존 유저

            if (result.additionalUserInfo.isNewUser) {
              // 신규유저라면, 모달창 닉네임 입력창 띄워짐
              $("#modalpopbtn").trigger("click");
              // 다 입력하고 완료 버튼 누르면,
              $("#okbtn").on("click", async () => {
                // 이 닉네임이 마이페이지에 뜨게됨
                await result.user.updateProfile({
                  displayName: $("#nameinput").val(),
                });
                // 유저정보 db에 저장
                await db
                  .collection("user")
                  .add({ 유저고유아이디: result.user.uid, 찜목록: [] });
                window.location.href = "/mypage.html";
              });
              // 그냥 닫기 버튼 누르면,
              $("#closebtn").on("click", async () => {
                //계정탈퇴 코드
                const user = await firebase.auth().currentUser;
                await user
                  .delete()
                  .then(() => {
                    alert("닉네임을 입력해주셔야 가입이 가능합니다!");
                    window.location.href = "/index.html";
                  })
                  .catch((error) => {
                    alert("error!");
                  });
              });
            } else {
              //기존 가입자면 패스
              window.location.href = "/index.html";
            }
          })
          .catch((error) => {});
      });

      // 로그아웃
      $("#logout").on("click", () => {
        firebase
          .auth()
          .signOut()
          .then(() => {
            alert("로그아웃 되었습니다");
            window.location.href = "/index.html";
          })
          .catch((error) => {});
      });
    </script>
  </body>
</html>
